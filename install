#!/bin/bash




$devcurn=$(pwd)
echo "Updating your current install to the latest packages."
sudo -S pacman -Syu

echo "Installing dependencies."
sudo -S pacman -S alacritty curl dmenu feh firefox fish gtk3 gtk4 i3-wm i3status lua luarocks maim neofetch neovim papirus-icon-theme picom thunar unzip xclip

if [ -d "$HOME/.mizOS" ]; then
	mv $HOME/.mizOS $HOME/mizOS
	mv $HOME/mizOS /var/
	sudo chmod 777 /var/mizOS
fi

installType=""

echo "Checking install type."
if [ -d "/var/mizOS" ]; then
	echo "| Performing system update."
	installType="update"
	sudo chmod -R 777 /var/mizOS
	sudo chmod -R 777 /var/mizOS/*
else
	echo "| Performing system install."
	installType="install"
	printf "\n\n\nAre you installing SystemD mizOS onto an Asus laptop? (y/n)\n\n> "
	read ans

	if [ $ans == "y" ]; then
		echo "Installing Asus laptop utilities."
		sudo -S pacman -S asusctl supergfxctl
		echo "Enabling asusctl and supergfxctl."
		printf "\n\n\n Are you using the ISO image? (y/n)"
		read ans
		if [ $ans == "y" ]; then
			echo " !! After installation, run miz gfx setup !!"
		else
			sudo -S systemctl enable --now power-profiles-daemon.service
			sudo -S systemctl enable --now supergfxd
		fi
	fi

	echo -e "Checking $HOME filesystem."
	echo "| Checking $HOME/.config"
	if [ -d "$HOME/.config" ]; then
		echo "  > $HOME/.config already exists."
	else
		echo "  > Creating $HOME/.config"
		mkdir $HOME/.config
	fi

	echo "| Checking $HOME/.themes"
	if [ -d "$HOME/.themes" ]; then
		echo "  > $HOME/.themes already exists."
	else
		echo "  > Creating $HOME/.themes"
		mkdir $HOME/.themes
	fi

	echo "| Checking $HOME/.icons"
	if [ -d "$HOME/.icons" ]; then
		echo "  > $HOME/.icons already exists."
	else
		echo "  > Creating $HOME/.icons"
		mkdir $HOME/.icons
	fi

	echo "  > Creating /var/mizOS"
	sudo mkdir /var/mizOS
	sudo chown -R root:root /var/mizOS
	sudo chmod -R 777 /var/mizOS
	echo "  > Enabling fish."
	echo "fish" >> $HOME/.bashrc
fi



echo -e "\nChecking filesystem."
echo "| Checking core folder."
if [ -d "/var/mizOS/core" ]; then
	echo "  > core folder present, updating."
	rm -rf /var/mizOS/core
else
	echo "  > Creating /var/mizOS/core"
fi
mkdir /var/mizOS/core

echo "| Checking src folder."
if [ -d "/var/mizOS/src" ]; then
	echo "  > src folder present."
else
	echo "  > Creating /var/mizOS/src"
	mkdir /var/mizOS/src
fi

echo "| Checking packages folder."
if [ -d "/var/mizOS/packages" ]; then
	echo "  > Packages folder present."
else
	echo "  > Creating /var/mizOS/packages"
	mkdir /var/mizOS/packages
fi

echo "| Checking repo folder."
if [ -d "/var/mizOS/repo" ]; then
	echo "  > repo folder present."
else
	echo "  > Creating /var/mizOS/repo"
	mkdir /var/mizOS/repo
fi

echo "| Checking work folder."
if [ -d "/var/mizOS/work" ]; then
	echo "  > work folder present."
else
	echo "  > Creating /var/mizOS/work"
	mkdir /var/mizOS/work
fi

echo "| Checking init folder."
if [ -d "/var/mizOS/init" ]; then
	echo "  > init folder present."
	echo "  > Clearing old init folder."
	rm -rf /var/mizOS/init/*
else
	echo "  > Creating init folder."
	mkdir /var/mizOS/init
fi

echo "| Checking security folder."
if [ -d "/var/mizOS/security" ]; then
	echo "  > security folder present."
else
	echo "  > Creating security folder."
	cp -r assets/os/security /var/mizOS
fi

echo "| Checking backup folder."
if [ -d "/var/mizOS/backup" ]; then
	echo "  > Backup folder present."
else
	echo "  > Creating backup folder."
	mkdir /var/mizOS/backup
fi

echo "| Checking config folder."
if [ -d "/var/mizOS/config" ]; then
	echo "  > config folder present."
else
	echo "  > Creating config folder."
	mkdir /var/mizOS/config
fi

echo "| Checking download folder."
if [ -d "/var/mizOS/download" ]; then
	echo "  > download folder present, clearing."
	rm -rf /var/mizOS/download/*
else
	echo "  > Creating download folder."
	mkdir /var/mizOS/download
fi


echo -e "\nConfiguring system."
echo "| Checking for existing configuration."
if [ -d "/var/mizOS/config/$USER" ]; then
	echo "  > Found."
	echo "| Checking for existing backup."
	if [ -d "/var/mizOS/backup/$USER" ]; then
		echo "  > Found, deleting."
		rm -rf /var/mizOS/backup/$USER
	fi
	echo "| Backing up current config to /var/mizOS/backup/$USER"
	mv /var/mizOS/config/$USER /var/mizOS/backup/
fi

mkdir /var/mizOS/config/$USER

echo "| Copying mizOS config directory structure."
cp -r assets/system_config/config/* /var/mizOS/config/$USER
echo "| Generating i3 config file."
/var/mizOS/config/$USER/i3/genconf

printf "\n\nWould you like to install GTK and icon themes? It may take a while. (y/n)\n\n> "
read ans
if [ $ans == "y" ]; then
echo "| Installing GTK theme."
echo "  > Preparing theme folder."
if [ ! -d "/var/mizOS/download/cat" ]; then
	mkdir /var/mizOS/download/cat
fi
echo "  > Downloading theme."
wget https://github.com/catppuccin/gtk/releases/download/v0.4.3/Catppuccin-Mocha-Standard-Pink-Dark.zip -O /var/mizOS/download/catppuccin.zip
echo "  > Extracting theme."
unzip /var/mizOS/download/catppuccin.zip -d /var/mizOS/download/cat
echo "  > Renaming theme files."
mv /var/mizOS/download/cat/Catppuccin-Mocha-Standard-Pink-Dark /var/mizOS/download/cat/Catppuccin
mv /var/mizOS/download/cat/Catppuccin-Mocha-Standard-Pink-Dark-hdpi /var/mizOS/download/cat/Catppuccin-hdpi
mv /var/mizOS/download/cat/Catppuccin-Mocha-Standard-Pink-Dark-xhdpi /var/mizOS/download/cat/Catppuccin-xhdpi
echo "  > Installing theme."
if [ -d "$HOME/.themes/catppuccin" ]; then
    rm -rf $HOME/.themes/Catppuccin
fi
if [ -d "$HOME/.themes/catppuccin-hdpi" ]; then
    rm -rf $HOME/.themes/Catppuccin-hdpi
fi
if [ -d "$HOME/.themes/catppuccin-xhdpi" ]; then
    rm -rf $HOME/.themes/Catppuccin-xhdpi
fi
mv /var/mizOS/download/cat/* $HOME/.themes
echo "  > Removing theme zip file."
rm /var/mizOS/download/catppuccin.zip

echo "| Installing cursor theme."
if [ ! -d "/var/mizOS/download/cat-cursor" ]; then
	mkdir /var/mizOS/download/cat-cursor
fi
echo "  > Downloading theme."
wget https://github.com/catppuccin/cursors/raw/main/cursors/Catppuccin-Mocha-Lavender-Cursors.zip -O /var/mizOS/download/cursor.zip
echo "  > Extracting theme."
unzip /var/mizOS/download/cursor.zip -d /var/mizOS/download/cat-cursor
echo "  > Renaming theme file."
mv /var/mizOS/download/cat-cursor/Catppuccin-Mocha-Lavender-Cursors /var/mizOS/download/cat-cursor/catppuccin-cursor
echo "  > Installing cursor theme."
if [ -d "$HOME/.icons/cat-cursor" ]; then
	rm -rf $HOME/.icons/cat-cursor
fi
sudo -S mv /var/mizOS/download/cat-cursor/catppuccin-cursor $HOME/.icons

echo "| Configuring Papirus icon pack."
echo "  > Downloading configurations."
git clone https://github.com/catppuccin/papirus-folders /var/mizOS/download/cat-papi
echo "  > Copying new icon files."
sudo -S cp -r /var/mizOS/download/cat-papi/src/* /usr/share/icons/Papirus
echo "  > Overwriting old icon files."
sudo -S /var/mizOS/download/cat-papi/papirus-folders -C cat-mocha-pink --theme Papirus-Dark

echo "| Writing GTK settings."
/var/mizOS/config/$USER/gtk/genconf
fi

echo "| Creating config file symlinks."
echo "  > Creating i3 symlink."
if [ -d "$HOME/.config/i3" ]; then
	rm -rf $HOME/.config/i3/*
else
	mkdir $HOME/.config/i3
fi
ln -s /var/mizOS/config/$USER/i3/config $HOME/.config/i3/config

echo "  > Creating gtk symlink."
if [ -f "$HOME/.config/gtk-3.0/settings.ini" ]; then
	rm $HOME/.config/gtk-3.0/settings.ini
fi
ln -s /var/mizOS/config/$USER/gtk/settings.ini $HOME/.config/gtk-3.0/settings.ini

echo "  > Creating picom symlink."
if [ -f "$HOME/.config/picom.conf" ]; then
	rm $HOME/.config/picom.conf
fi
ln -s /var/mizOS/config/$USER/picom/picom.conf $HOME/.config/picom.conf

echo "  > Creating alacritty symlink."
if [ -d "$HOME/.config/alacritty" ]; then
	rm -rf $HOME/.config/alacritty/*
else
	mkdir $HOME/.config/alacritty
fi
ln -s /var/mizOS/config/$USER/alacritty/alacritty.yml $HOME/.config/alacritty/alacritty.yml

echo "  > Creating fish symlink."
if [ -d "$HOME/.config/fish" ]; then
	rm -rf $HOME/.config/fish/*
else
	mkdir $HOME/.config/fish
fi
ln -s /var/mizOS/config/$USER/fish/config.fish $HOME/.config/fish/config.fish



echo -e "\nInstalling core system."
echo "| Detecting init system."
if test -f "/usr/bin/sv"; then
        echo "  > Runit detected."
        cp assets/os/init/runit/init.lua /var/mizOS/init
elif test -f "/usr/bin/systemctl"; then
        echo "  > SystemD detected."
        cp assets/os/init/systemd/init.lua /var/mizOS/init
elif test -f "/usr/bin/rc-service"; then
        echo "  > OpenRC detected."
        cp assets/os/init/openrc/init.lua /var/mizOS/init
fi
echo "| Installing frontend and backend."
echo "  > Installing the mizOS.lua backend."
if [ -f "/var/mizOS/core/mizOS.lua" ]; then
	rm /var/mizOS/core/mizOS.lua
fi
cp assets/os/core/mizOS.lua /var/mizOS/core
cp -r assets/os/core/libraries /var/mizOS/core

echo "  > Installing the miz frontend."
if [ -f "/usr/bin/miz" ]; then
	sudo -S rm /usr/bin/miz
fi
chmod +x assets/os/miz
sudo -S cp assets/os/miz /usr/bin



echo -e "\nFinishing up."
echo "| Installing system identification files."
echo "  > Replacing /etc/os-release"
sudo -S rm /etc/os-release
sudo -S cp assets/details/os-release /etc

echo "  > Replacing /etc/lsb-release"
sudo -S rm /etc/lsb-release
sudo -S cp assets/details/lsb-release /etc

echo "  > Replacing /usr/bin/neofetch"
sudo -S rm /usr/bin/neofetch
sudo -S cp assets/details/neofetch /usr/bin


if [[ $1 == "dev" ]]; then
	echo -e "\nDev mode active."
	sudo -S cp assets/dev/miz /usr/bin/
	sudo rm -rf /var/mizOS/core
	cp -r assets/dev/core /var/mizOS
fi

echo "| Checking source folder."
if [ -d "/var/mizOS/src/mizOS" ]; then
	echo "  > Cleaning source folder."
	rm -rf /var/mizOS/src/mizOS
else
	echo "  > Source folder not found, enjoy your mizOS installation :)"
fi

echo "| Setting mizOS filesystem base ownership."
echo "  > /var/mizOS     -  root:root"
sudo chown -R root:root /var/mizOS

echo "| Setting mizOS filesystem permissions."
echo "  > /var/mizOS           -  755"
sudo chmod -R 755 /var/mizOS
echo "  > /var/mizOS/core      -  755"
sudo chmod -R 755 /var/mizOS/core
echo "  > /var/mizOS/init      -  755"
sudo chmod -R 755 /var/mizOS/init
echo "  > /var/mizOS/repo      -  755"
sudo chmod -R 755 /var/mizOS/repo
echo "  > /var/mizOS/packages  -  755"
sudo chmod -R 755 /var/mizOS/packages
echo "  > /var/mizOS/security  -  755"
sudo chmod -R 755 /var/mizOS/security
echo "  > /var/mizOS/work      -  755"
sudo chmod -R 755 /var/mizOS/work
echo "  > /var/mizOS/src       -  755"
sudo chmod -R 755 /var/mizOS/src
echo "  > /var/mizOS/config    -  755"
sudo chmod -R 755 /var/mizOS/config
for d in /var/mizOS/config/*/; do
	dn=$(basename $d)
	echo "  > $d   - 755 (Ownership: $dn:$dn)"
	sudo chown -R $dn:$dn $d
	sudo chmod -R 755 $d
done
echo "  > /var/mizOS/download  -  777"
sudo chmod -R 777 /var/mizOS/download
for d in /var/mizOS/backup/*/; do
	dn=$(basename $d)
	echo "  > $d   - 755 (Ownership: $dn:$dn)"
	sudo chown -R $dn:$dn $d
	sudo chmod -R 755 $d
done

echo -e "\n\n"
if [ "$installType" = "install" ]; then
	echo "My work here is done! You should probably reboot."
	echo "  "
	echo "If you are currently using i3-gaps, reload with MOD+shift+c."
	echo " "
	echo -e "mizOS theming is installed on a per-user basis. If you want mizOS theming on another user, run \"miz update\" from that user."
	echo " "
	echo -e "Remember, \"sudo pacman -Syu\" does not update mizOS, use \"miz update\" instead."
fi
